---
title: "互動式經濟資料視覺化"
output: output_format
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(plotly)
# Paste your drake Rdata loading here
xfun::download_file("https://www.dropbox.com/s/zwlewu5enjlkrgy/maps_drake.Rdata?dl=1", mode="wb")
load("maps_drake.Rdata")
```


```{r}
.root <- rprojroot::is_rstudio_project$make_fix_file()
drake$.updateCache()
drake$source_plan()
drake$makePlan()
```

load target
```{r}
drake$loadTarget$pltWithoutI()
pltWithoutI
```

see original code
```{r}
drake$clipCommand$pltWithoutI() # store in your clipboard after running this command
```

paste in the place you want to see the code

# Heritage

  * each row is one heritage site. 
  
  * each heritage site has longitude and latitude data
  
The goal is to construct a **Simple Feature** data frame (sf) from it: 

```{r}
drake$loadTarget$heritageData()
```

To understand what a sf data frame is:

```{r}
drake$loadTarget$sf_unnamed_taipei()
sf_tpe_multipolygons <- sf_unnamed_taipei$osm_multipolygons
```

The key is on its **geometry** column, which is called **simple feature column** (sfc):

```{r}
sf_tpe_multipolygons$geometry %>% class()
```
  * has class **sfc**.

sfc shows you what kind of geometry each record is:

```{r}
sf_tpe_multipolygons$geometry[[1]] # geometry: multipolygon
sf_tpe_multipolygons$name[[1]]
```

***

To form a **sf** data frame, you need to know how to form a **sfc** first, which requires:

  * construct simple feature geometry (**sfg**) for **each row record** from the original longitude-latitude points:
  
sfc <-  sfg (multipolygon) <- c(121.4588 25.12292), ...,  c(121.4588 25.12292)

```{r}
# If you have trouble download heritage json directly, run the following instead:
xfun::download_file("https://www.dropbox.com/s/s4mv5ebhsqanpew/heritage.Rdata?dl=1", mode="wb")
load("heritage.Rdata")
```

***

To deal with simple features, you need:  
```{r}
library(sf)
```

```{r}
list_points <- vector("list", length(nrow()))
heritageData %>%
  select(caseName, longitude, latitude) %>%
  na.omit() -> heritageDataComplete
```

```{r}
heritageDataComplete[1, ][c("longitude", "latitude")]
```

```{r}
heritageDataComplete[1, ][c("longitude", "latitude")] %>%
  as.matrix() %>%
  sf::st_point() 
```

```{r}
list_points = vector("list", length(nrow(heritageDataComplete)))
for(i in 1:nrow(heritageDataComplete)){
  list_points[[i]] = {
    heritageDataComplete[i, ][c("longitude", "latitude")] %>%
      as.matrix() %>%
      sf::st_point()
  }
}
```

```{r}
sfc_points <- sf::st_sfc(list_points)
```

```{r}
# 1 form your own PROPER data frame which has a sfc column called geometry
sf_heritage <- 
  data.frame(
    caseName = heritageDataComplete$caseName,
    geometry = sfc_points
  )
class(sf_heritage)

# 2 convert proper data frame to sf data frame
sf_heritage <- sf::st_as_sf(sf_heritage)
```

```{r}
sf_taipei <-  sf_unnamed_taipei$osm_multipolygons
class(sf_taipei)
```

```{r}
plot_ly() %>%
  add_sf(
    data=sf_taipei
  ) %>%
  add_sf(
    data=sf_heritage
  )
```


## set CRS for sf_heritage

```{r}
crsX <- sf::st_crs(sf_taipei$geometry)
```


```{r}
sf::st_set_crs(sf_heritage$geometry, crsX) -> sf_heritage$geometry
```

```{r}
sf_heritage$geometry
```

## bbox cropping sf_heritage

```{r}
sf_taipei$geometry
```

```{r}
bb_taipei <- sf::st_bbox(sf_taipei$geometry)
sf::st_crop(sf_heritage, bb_taipei) -> sf_heritage
```


```{r}
sf_heritage$geometry
```


```{r}
plot_ly() %>%
  add_sf(
    data=sf_taipei
  ) %>%
  add_sf(
    data=sf_heritage
  )
```

## Import gpx data (xml)

更新econR:  
```{r}
remotes::install_github("tpemartin/econR", force = T)
```

引入gpx資料並轉成list of longitude-latitude
```{r}
library(dplyr)
xml2::read_xml("https://www.dropbox.com/s/0nyv3m2tuhftigs/%E7%8E%8B%E5%85%AC%E5%BB%9F.gpx?dl=1") -> xml_gpx
xml_gpx %>% econR::gpx_as_list() -> list_lon_lat
```

